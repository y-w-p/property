<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.ywp.dao.UserDao">
    <resultMap id="userMap" type="com.ywp.entity.User" >
        <id column="user_id" property="user_id" jdbcType="INTEGER" />
        <result column="user_name" property="user_name" jdbcType="VARCHAR" />
        <result column="user_password" property="user_password" jdbcType="VARCHAR" />
        <result column="user_idcard" property="user_idcard" jdbcType="VARCHAR" />
        <result column="user_phonenumber" property="user_phonenumber" jdbcType="VARCHAR" />
        <result column="user_address" property="user_address" jdbcType="VARCHAR" />
        <result column="user_area" property="user_area" jdbcType="VARCHAR" />
        <result column="user_carnumber" property="user_carnumber" jdbcType="VARCHAR" />
    </resultMap>

    <resultMap id="userParkMap" type="com.ywp.entity.User_park" >
          <id column="park_id" property="park_id" jdbcType="INTEGER" />
          <result column="user_id" property="user_id" jdbcType="INTEGER" />
           <result column="user_name" property="user_name" jdbcType="INTEGER" />
           <result column="user_carnumber" property="user_carnumber" jdbcType="INTEGER" />
          <result column="park_location" property="park_location" jdbcType="VARCHAR" />
          <result column="park_start_time" property="park_start_time" jdbcType="TIMESTAMP" />
          <result column="park_end_time" property="park_end_time" jdbcType="TIMESTAMP" />
    </resultMap>

    <resultMap id="userParkCostMap" type="com.ywp.entity.User_park" >
          <id column="cost_id" property="cost_id" jdbcType="INTEGER" />
          <result column="user_id" property="user_id" jdbcType="INTEGER" />
           <result column="user_name" property="user_name" jdbcType="INTEGER" />
           <result column="user_carnumber" property="user_carnumber" jdbcType="INTEGER" />
          <result column="park_start_time" property="park_start_time" jdbcType="TIMESTAMP" />
          <result column="park_end_time" property="park_end_time" jdbcType="TIMESTAMP" />
           <result column="park_id" property="park_id" jdbcType="INTEGER" />
           <result column="period" property="period" jdbcType="BIGINT" />
           <result column="status" property="status" jdbcType="VARCHAR" />
      </resultMap>




    <!--业主登录-->
    <select id="userLogin" parameterType="String" resultMap="userMap">
        select * from user where user_name=#{user_name} and user_password=#{user_password}
    </select>

    <!--业主注册-->
   <insert id="userRegistered" parameterType="String">
       <!--注册插入后获取Id-->
       <selectKey keyProperty="user_id" keyColumn="user_id" resultType="int" order="AFTER">
           select last_insert_id();
       </selectKey>
       insert into user (user_name,user_password,user_idcard,user_phonenumber,user_address,user_area,user_carnumber) values (#{user_name},#{user_password},#{user_idcard},#{user_phonenumber},#{user_address},#{user_area},#{user_carnumber})
   </insert>


    <!--通过业主名称查找业主-->
    <select id="findUserByName" parameterType="String" resultMap="userMap">
        select * from user where user_name = #{user_name}
    </select>



    <!--游客个人信息修改(包括用户名)-->
    <update id="user_info_update" parameterType="com.ywp.entity.User">
        update user set user_name = #{user_name},user_password=#{user_password},user_idcard=#{user_idcard},user_phonenumber=#{user_phonenumber},user_address=#{user_address},user_area=#{user_area},user_carnumber=#{user_carnumber} where user_id=#{user_id}
    </update>

    <!--游客个人信息修改(不包括用户名)-->
    <update id="user_info_save" parameterType="com.ywp.entity.User">
        update user set user_password=#{user_password},user_idcard=#{user_idcard},user_phonenumber=#{user_phonenumber},user_address=#{user_address},user_area=#{user_area},user_carnumber=#{user_carnumber} where user_id=#{user_id}
    </update>

    <!--通过业主id，查找业主停车记录-->
    <select id="findUserParkByID" parameterType="int" resultMap="userParkMap">
        select park_id,user_name,user_carnumber,park_location,park_start_time,park_end_time from user_park up,user u where up.user_id = #{user_id} and u.user_id = #{user_id}
    </select>

    <!--通过业主id，查找业主停车账单-->
    <select id="findUserParkCostByID" parameterType="int" resultMap="userParkCostMap">
         SELECT upc.cost_id, u.user_name, u.user_carnumber,up.park_start_time,up.park_end_time, TIMESTAMPDIFF(MINUTE,park_start_time,park_end_time) AS period ,upc.status from user_park up,user u, user_park_cost upc WHERE up.user_id=#{user_id} and u.user_id=#{user_id} and up.park_id = upc.park_id
    </select>

    <!--通过业主id，查找业主物业账单-->
    <select id="findUserPropertyCostByID" parameterType="int" resultType="com.ywp.entity.Property">
      SELECT property_id,admin_name,user_name,user_area,year,month,publish_time,status from property p, user u
      where p.user_id = #{user_id} and u.user_id=#{user_id}
    </select>

    <!--业主缴纳物业费用-->
    <update id="delivery_property" parameterType="int">
        update property set status = 1 where property_id = #{property_id}
    </update>

</mapper>